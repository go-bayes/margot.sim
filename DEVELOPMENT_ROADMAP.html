<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>margot.sim Development Roadmap • margot.sim</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="margot.sim Development Roadmap"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">margot.sim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes"><li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="articles/basic-simulation.html">Basic Simulation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Topics</h6></li>
    <li><a class="dropdown-item" href="articles/applying-shadows.html">Applying Observational Shadows</a></li>
    <li><a class="dropdown-item" href="articles/truncation-coarsening.html">Truncation and Coarsening</a></li>
    <li><a class="dropdown-item" href="articles/monte-carlo-simple.html">Monte Carlo Evaluation</a></li>
    <li><a class="dropdown-item" href="articles/shift-interventions.html">Shift Interventions</a></li>
    <li><a class="dropdown-item" href="articles/transport-weights-shadows.html">Transport Weights and Shadows</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Practical Applications</h6></li>
    <li><a class="dropdown-item" href="articles/shift-weights.html">Shift Interventions with Sampling Weights</a></li>
    <li><a class="dropdown-item" href="articles/censoring-effect-mod.html">Censoring and Effect Modification</a></li>
    <li><a class="dropdown-item" href="articles/heterogeneous-effects.html">Heterogeneous Treatment Effects</a></li>
    <li><a class="dropdown-item" href="articles/advanced-shift-interventions.html">Advanced Shift Interventions</a></li>
    <li><a class="dropdown-item" href="articles/misclassification-bias.html">Misclassification Bias</a></li>
    <li><a class="dropdown-item" href="articles/scenario-sensitivity.html">Scenario-Based Sensitivity Analysis</a></li>
    <li><a class="dropdown-item" href="articles/practical-workflow.html">Complete Analysis Workflow</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/go-bayes/margot.sim" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>margot.sim Development Roadmap</h1>
      <small class="dont-index">Source: <a href="https://github.com/go-bayes/margot.sim/blob/main/DEVELOPMENT_ROADMAP.md" class="external-link"><code>DEVELOPMENT_ROADMAP.md</code></a></small>
    </div>

<div id="margotsim-development-roadmap" class="section level1">

<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<p>This document consolidates feedback from the recent code review with existing implementation plans, creating a unified roadmap for package development. The roadmap prioritises architectural improvements that must be completed before the API solidifies, while maintaining the package’s core strengths of usability and the intuitive “shadow” metaphor.</p>
</div>
<div class="section level2">
<h2 id="immediate-priorities-do-before-api-solidifies">Immediate Priorities (Do Before API Solidifies)<a class="anchor" aria-label="anchor" href="#immediate-priorities-do-before-api-solidifies"></a></h2>
<div class="section level3">
<h3 id="id_1-formal-object-system-s3r6">1. Formal Object System (S3/R6)<a class="anchor" aria-label="anchor" href="#id_1-formal-object-system-s3r6"></a></h3>
<p><strong>Status</strong>: Not started<br><strong>Priority</strong>: CRITICAL - Must be done before external users adopt the package<br><strong>Why</strong>: Once users start writing shadows and scenarios, changing the object system will break their code</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># S3 approach (recommended for simplicity)</span></span>
<span><span class="va">new_shadow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">type</span>, <span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="va">type</span>, params <span class="op">=</span> <span class="va">params</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"_shadow"</span><span class="op">)</span>, <span class="st">"margot_shadow"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">new_scenario</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span>, <span class="va">description</span>, <span class="va">shadows</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span>, description <span class="op">=</span> <span class="va">description</span>, shadows <span class="op">=</span> <span class="va">shadows</span><span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"margot_scenario"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generic methods</span></span>
<span><span class="va">print.margot_shadow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Shadow:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">type</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Parameters:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">params</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">validate.margot_shadow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Shadow-specific validation</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"validate"</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Files to modify</strong>: - <code>R/margot-shadows.R</code> - Convert shadow functions to S3 - <code>R/margot-scenario.R</code> - Convert scenario functions to S3 - Add new file: <code>R/margot-s3-methods.R</code> for generic methods</p>
</div>
<div class="section level3">
<h3 id="id_2-seed-discipline--parallel-rng">2. Seed Discipline &amp; Parallel RNG<a class="anchor" aria-label="anchor" href="#id_2-seed-discipline--parallel-rng"></a></h3>
<p><strong>Status</strong>: Partially implemented (basic seed support exists)<br><strong>Priority</strong>: CRITICAL - Silent reproducibility failures are unacceptable<br><strong>Why</strong>: Current parallel implementation may not guarantee reproducibility</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Option 1: future package approach</span></span>
<span><span class="va">margot_monte_carlo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multisession.html" class="external-link">multisession</a></span>, seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span><span class="va">seed</span>, <span class="op">{</span></span>
<span>      <span class="co"># Run simulations</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Option 2: parallel package approach</span></span>
<span><span class="va">margot_monte_carlo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">RNGkind</a></span><span class="op">(</span><span class="st">"L'Ecuyer-CMRG"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>    <span class="fu">mc.reset.stream</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># Use parallel::mclapply with mc.set.seed = TRUE</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Files to modify</strong>: - <code>R/monte-carlo.R</code> - Implement proper RNG stream management - All simulation functions to accept and propagate seed parameter</p>
</div>
<div class="section level3">
<h3 id="id_3-shadow-algebradependencies">3. Shadow Algebra/Dependencies<a class="anchor" aria-label="anchor" href="#id_3-shadow-algebradependencies"></a></h3>
<p><strong>Status</strong>: Not implemented<br><strong>Priority</strong>: HIGH - Shadows can interact in unexpected ways<br><strong>Why</strong>: E.g., truncation changes variance assumptions for measurement error</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Shadow dependency system</span></span>
<span><span class="va">shadow_dependencies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  truncation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    affects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"variance"</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>    update_fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">truncation_params</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Recalculate variance after truncation</span></span>
<span>      <span class="va">params</span><span class="op">$</span><span class="va">variance</span> <span class="op">&lt;-</span> <span class="fu">calculate_truncated_variance</span><span class="op">(</span></span>
<span>        <span class="va">params</span><span class="op">$</span><span class="va">variance</span>, </span>
<span>        <span class="va">truncation_params</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">params</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">apply_shadows_with_dependencies</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">shadows</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Apply shadows in dependency order</span></span>
<span>  <span class="va">ordered_shadows</span> <span class="op">&lt;-</span> <span class="fu">topological_sort_shadows</span><span class="op">(</span><span class="va">shadows</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">shadow</span> <span class="kw">in</span> <span class="va">ordered_shadows</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Check for upstream effects</span></span>
<span>    <span class="va">upstream_params</span> <span class="op">&lt;-</span> <span class="fu">get_upstream_parameters</span><span class="op">(</span><span class="va">shadow</span>, <span class="va">applied_shadows</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Update parameters if needed</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">upstream_params</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">shadow</span><span class="op">$</span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/update_shadow_params.html">update_shadow_params</a></span><span class="op">(</span><span class="va">shadow</span>, <span class="va">upstream_params</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Apply shadow</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/apply_shadow.html">apply_shadow</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">shadow</span><span class="op">)</span></span>
<span>    <span class="va">applied_shadows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">applied_shadows</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">shadow</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Files to modify</strong>: - <code>R/margot-shadows.R</code> - Add dependency system - New file: <code>R/margot-shadow-dependencies.R</code></p>
</div>
<div class="section level3">
<h3 id="id_4-positivity--support-diagnostics">4. Positivity &amp; Support Diagnostics<a class="anchor" aria-label="anchor" href="#id_4-positivity--support-diagnostics"></a></h3>
<p><strong>Status</strong>: Not implemented<br><strong>Priority</strong>: HIGH - Users need this immediately<br><strong>Why</strong>: Violated positivity is a common cause of estimator failure</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">margot_check_positivity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">treatment_var</span>, <span class="va">covariates</span>, </span>
<span>                                   <span class="va">threshold</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="va">plot</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate propensity scores</span></span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">treatment_var</span>, <span class="st">"~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">covariates</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ps_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">data</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">propensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ps_model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Check for violations</span></span>
<span>  <span class="va">violations</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">treatment_var</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span></span>
<span>      min_ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">propensity</span><span class="op">)</span>,</span>
<span>      max_ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">propensity</span><span class="op">)</span>,</span>
<span>      n_extreme <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">propensity</span> <span class="op">&lt;</span> <span class="va">threshold</span> <span class="op">|</span> <span class="va">propensity</span> <span class="op">&gt;</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">threshold</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      n_eff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">propensity</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">propensity</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Plot if requested</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">plot</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">propensity</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu">sym</span><span class="op">(</span><span class="va">treatment_var</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_density</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">threshold</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">threshold</span><span class="op">)</span>, </span>
<span>                 linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Propensity Score Distribution"</span>,</span>
<span>           subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Positivity threshold:"</span>, <span class="va">threshold</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Return diagnostics</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      violations <span class="op">=</span> <span class="va">violations</span>,</span>
<span>      n_violations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">violations</span><span class="op">$</span><span class="va">n_extreme</span><span class="op">)</span>,</span>
<span>      effective_sample_size <span class="op">=</span> <span class="va">violations</span><span class="op">$</span><span class="va">n_eff</span>,</span>
<span>      plot <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="va">plot</span><span class="op">)</span> <span class="va">p</span> <span class="kw">else</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"margot_positivity_check"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Files to create</strong>: - <code>R/margot-diagnostics.R</code> - Positivity and support checks</p>
</div>
<div class="section level3">
<h3 id="id_5-memory-management">5. Memory Management<a class="anchor" aria-label="anchor" href="#id_5-memory-management"></a></h3>
<p><strong>Status</strong>: Not implemented<br><strong>Priority</strong>: HIGH - Large simulations can exhaust memory<br><strong>Why</strong>: 1000 reps × 10,000 rows × 50 vars × 2 (true/observed) = 2-3 GB</p>
<p><strong>Implementation options</strong>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Option 1: Streaming to disk</span></span>
<span><span class="va">margot_monte_carlo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">output_dir</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">keep</span> <span class="op">=</span> <span class="st">"summary"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">output_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Stream results to parquet files</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_reps</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">run_single_simulation</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">keep</span> <span class="op">==</span> <span class="st">"summary"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Only save summary statistics</span></span>
<span>        <span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu">calculate_summary</span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>        <span class="fu">arrow</span><span class="fu">::</span><span class="fu">write_parquet</span><span class="op">(</span><span class="va">summary</span>, </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"summary_%04d.parquet"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Save full data</span></span>
<span>        <span class="fu">arrow</span><span class="fu">::</span><span class="fu">write_parquet</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">data</span>, </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">output_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"data_%04d.parquet"</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Option 2: On-the-fly summarisation</span></span>
<span><span class="va">margot_monte_carlo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">summarise_fn</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">summarise_fn</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Only keep summaries in memory</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_reps</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu">run_single_simulation</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>      <span class="fu">summarise_fn</span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span>  <span class="co"># User-defined summary function</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Files to modify</strong>: - <code>R/monte-carlo.R</code> - Add memory management options</p>
</div>
<div class="section level3">
<h3 id="id_6-enhanced-testing-infrastructure">6. Enhanced Testing Infrastructure<a class="anchor" aria-label="anchor" href="#id_6-enhanced-testing-infrastructure"></a></h3>
<p><strong>Status</strong>: Basic tests exist (54% coverage)<br><strong>Priority</strong>: HIGH - Need property-based tests<br><strong>Why</strong>: Must verify bias → 0 as shadow → 0</p>
<p><strong>Implementation</strong>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Property-based test example</span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"bias approaches zero as shadow strength decreases"</span>, <span class="op">{</span></span>
<span>  <span class="va">shadow_strengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">biases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">shadow_strengths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">strength</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/margot_simulate.html">margot_simulate</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>      params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>true_effect <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      shadows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="reference/create_shadow.html">create_shadow</a></span><span class="op">(</span><span class="st">"measurement_error"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="va">strength</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Calculate bias</span></span>
<span>    <span class="va">estimated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">$</span><span class="va">estimated_effect</span><span class="op">)</span></span>
<span>    <span class="va">true</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">estimated</span> <span class="op">-</span> <span class="va">true</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Bias should decrease monotonically</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">biases</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Final bias should be near zero</span></span>
<span>  <span class="fu">expect_lt</span><span class="op">(</span><span class="va">biases</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">biases</span><span class="op">)</span><span class="op">]</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><strong>Files to create</strong>: - <code>tests/testthat/test-properties.R</code> - Property-based tests - Update existing tests to improve coverage</p>
</div>
<div class="section level3">
<h3 id="id_7-cran-compliance">7. CRAN Compliance<a class="anchor" aria-label="anchor" href="#id_7-cran-compliance"></a></h3>
<p><strong>Status</strong>: Package passes basic R CMD check<br><strong>Priority</strong>: HIGH - Must be sorted before submission<br><strong>Why</strong>: CRAN requirements affect design decisions</p>
<p><strong>Checklist</strong>: - [ ] Reduce example data to &lt; 5 MB - [ ] Set <code>LazyData: false</code> if data is large - [ ] Ensure all examples run in &lt; 5 seconds - [ ] Add <code>\donttest{}</code> for longer examples - [ ] Check for platform-specific code - [ ] Verify no external dependencies in tests</p>
</div>
</div>
<div class="section level2">
<h2 id="next-phase-cran-submission-priorities">Next Phase: CRAN Submission Priorities<a class="anchor" aria-label="anchor" href="#next-phase-cran-submission-priorities"></a></h2>
<p>Based on IMPLEMENTATION_PLAN.md, these are scheduled for completion before CRAN submission:</p>
<div class="section level3">
<h3 id="id_1-natural-value-interventions">1. Natural Value Interventions<a class="anchor" aria-label="anchor" href="#id_1-natural-value-interventions"></a></h3>
<p><strong>Status</strong>: Design complete, not implemented<br><strong>Priority</strong>: MEDIUM<br><strong>Files</strong>: <code>R/margot-simulate-core.R</code> lines 436-444</p>
</div>
<div class="section level3">
<h3 id="id_2-comprehensive-vignettes">2. Comprehensive Vignettes<a class="anchor" aria-label="anchor" href="#id_2-comprehensive-vignettes"></a></h3>
<p><strong>Status</strong>: Outlined in detail<br><strong>Priority</strong>: HIGH - <code>heterogeneous-effects-tutorial.Rmd</code> - <code>practical-shift-interventions.Rmd</code> - <code>monte-carlo-best-practices.Rmd</code> - <code>unmeasured-confounding.Rmd</code></p>
</div>
<div class="section level3">
<h3 id="id_3-unmeasured-confounder-u">3. Unmeasured Confounder U<a class="anchor" aria-label="anchor" href="#id_3-unmeasured-confounder-u"></a></h3>
<p><strong>Status</strong>: Design complete, not implemented<br><strong>Priority</strong>: MEDIUM<br><strong>Implementation</strong>: Add U parameters to <code><a href="reference/dot-default_sim_params.html">.default_sim_params()</a></code></p>
</div>
</div>
<div class="section level2">
<h2 id="long-term-features-post-cran">Long-term Features (Post-CRAN)<a class="anchor" aria-label="anchor" href="#long-term-features-post-cran"></a></h2>
<p>From the implementation plan and code review:</p>
<div class="section level3">
<h3 id="phase-1-enhanced-shadow-framework">Phase 1: Enhanced Shadow Framework<a class="anchor" aria-label="anchor" href="#phase-1-enhanced-shadow-framework"></a></h3>
<ul><li>Shadow parameter library (YAML/JSON manifests)</li>
<li>Advanced shadow plotting and DAG visualisation</li>
<li>Shadow composition algebra</li>
</ul></div>
<div class="section level3">
<h3 id="phase-2-theoretical-enhancements">Phase 2: Theoretical Enhancements<a class="anchor" aria-label="anchor" href="#phase-2-theoretical-enhancements"></a></h3>
<ul><li>Frugal parameterisation interface (<code>margot_simulate_frugal()</code>)</li>
<li>SCM constructor approach</li>
<li>Variation independence testing</li>
</ul></div>
<div class="section level3">
<h3 id="phase-3-advanced-features">Phase 3: Advanced Features<a class="anchor" aria-label="anchor" href="#phase-3-advanced-features"></a></h3>
<ul><li>Shift intervention engine completion</li>
<li>Benchmark suite with classic estimators</li>
<li>Cross-language support (Python wrapper)</li>
<li>Path-specific effects and natural direct/indirect effects</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="testing--documentation-strategy">Testing &amp; Documentation Strategy<a class="anchor" aria-label="anchor" href="#testing--documentation-strategy"></a></h2>
<div class="section level3">
<h3 id="testing-priorities">Testing Priorities<a class="anchor" aria-label="anchor" href="#testing-priorities"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Property-based tests</strong> - Invariants like bias → 0</li>
<li>
<strong>Shadow interaction tests</strong> - Verify dependency system</li>
<li>
<strong>Memory/performance tests</strong> - Large simulation benchmarks</li>
<li>
<strong>CRAN compliance tests</strong> - Platform independence</li>
</ol></div>
<div class="section level3">
<h3 id="documentation-priorities">Documentation Priorities<a class="anchor" aria-label="anchor" href="#documentation-priorities"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>API documentation</strong> - Complete roxygen2 for all functions</li>
<li>
<strong>Vignettes</strong> - Four comprehensive tutorials</li>
<li>
<strong>README updates</strong> - Add limitations section</li>
<li>
<strong>pkgdown site</strong> - Update after each major feature</li>
</ol></div>
</div>
<div class="section level2">
<h2 id="implementation-order">Implementation Order<a class="anchor" aria-label="anchor" href="#implementation-order"></a></h2>
<div class="section level3">
<h3 id="week-1-2-architecture-must-do-now">Week 1-2: Architecture (MUST DO NOW)<a class="anchor" aria-label="anchor" href="#week-1-2-architecture-must-do-now"></a></h3>
<ol style="list-style-type: decimal"><li>Implement S3 object system</li>
<li>Fix RNG/seed discipline</li>
<li>Add shadow dependency system</li>
<li>Create positivity diagnostics</li>
</ol></div>
<div class="section level3">
<h3 id="week-3-4-infrastructure">Week 3-4: Infrastructure<a class="anchor" aria-label="anchor" href="#week-3-4-infrastructure"></a></h3>
<ol style="list-style-type: decimal"><li>Memory management options</li>
<li>Property-based tests</li>
<li>CRAN compliance fixes</li>
</ol></div>
<div class="section level3">
<h3 id="week-5-6-features--documentation">Week 5-6: Features &amp; Documentation<a class="anchor" aria-label="anchor" href="#week-5-6-features--documentation"></a></h3>
<ol style="list-style-type: decimal"><li>Natural value interventions</li>
<li>Unmeasured confounder U</li>
<li>Write comprehensive vignettes</li>
<li>Update all documentation</li>
</ol></div>
<div class="section level3">
<h3 id="post-cran-advanced-features">Post-CRAN: Advanced Features<a class="anchor" aria-label="anchor" href="#post-cran-advanced-features"></a></h3>
<ul><li>Implement based on user feedback and priorities</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="success-metrics">Success Metrics<a class="anchor" aria-label="anchor" href="#success-metrics"></a></h2>
<ul class="task-list"><li><label><input type="checkbox">All high-priority items complete before API release</label></li>
<li><label><input type="checkbox">Test coverage &gt; 80%</label></li>
<li><label><input type="checkbox">All vignettes render without errors</label></li>
<li><label><input type="checkbox">Memory usage &lt; 4GB for standard simulations</label></li>
<li><label><input type="checkbox">CRAN checks pass on all platforms</label></li>
<li><label><input type="checkbox">Reproducibility guaranteed across parallel runs</label></li>
</ul></div>
<div class="section level2">
<h2 id="file-structure-changes">File Structure Changes<a class="anchor" aria-label="anchor" href="#file-structure-changes"></a></h2>
<div class="section level3">
<h3 id="new-files-required">New Files Required<a class="anchor" aria-label="anchor" href="#new-files-required"></a></h3>
<pre><code>R/
├── margot-s3-methods.R          # S3 generic methods
├── margot-shadow-dependencies.R  # Shadow interaction system
├── margot-diagnostics.R         # Positivity &amp; support checks
└── margot-memory.R              # Memory management utilities

tests/testthat/
├── test-properties.R            # Property-based tests
├── test-reproducibility.R       # RNG stream tests
└── test-memory.R               # Memory usage tests

vignettes/
├── heterogeneous-effects-tutorial.Rmd
├── practical-shift-interventions.Rmd
├── monte-carlo-best-practices.Rmd
└── unmeasured-confounding.Rmd</code></pre>
</div>
<div class="section level3">
<h3 id="files-to-modify">Files to Modify<a class="anchor" aria-label="anchor" href="#files-to-modify"></a></h3>
<pre><code>R/
├── margot-shadows.R            # Convert to S3
├── margot-scenario.R           # Convert to S3
├── monte-carlo.R               # Add RNG discipline
└── margot-simulate-core.R      # Natural values, U confounder

man/
└── *.Rd                        # Update all documentation</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a></h2>
<ul><li>Maintain backward compatibility throughout</li>
<li>Document all breaking changes if absolutely necessary</li>
<li>Keep the simple API for basic use cases</li>
<li>Advanced features should be opt-in, not required</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Joseph Bulbulia.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

