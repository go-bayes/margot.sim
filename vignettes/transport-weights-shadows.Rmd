---
title: "Transport Weights and Shadow Bias Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Transport Weights and Shadow Bias Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r setup}
# Load package using devtools if not installed
if (!requireNamespace("margot.sim", quietly = TRUE)) {
  devtools::load_all()
} else {
  library(margot.sim)
}
library(ggplot2)
library(dplyr)
```

## Introduction

This vignette demonstrates how to use margot.sim for transportability analyses, where we want to:

1. **Transport results** from a study sample to a target population
2. **Account for effect modification** that differs between sample and population
3. **Evaluate how observational shadows** (measurement error, missingness) affect transported estimates

The key insight is that bias from observational distortions can differ between the source and target populations, particularly when there's effect heterogeneity.

## Basic Transport Weights

### The Transport Problem

Imagine we have:
- A **study sample** where only 10% of participants are elderly (Z=1)
- A **target population** where 50% are elderly
- A treatment that works better in elderly patients (effect modification)

The average treatment effect (ATE) in our sample won't match the ATE in the target population. Transport weights adjust for this difference.

### Simple Example

```{r basic-transport}
# Generate data with transport weights
set.seed(2025)
data <- simulate_ate_data_with_weights(
  n_sample = 2000,
  n_population = 20000,
  p_z_sample = 0.1,      # 10% elderly in sample
  p_z_population = 0.5,   # 50% elderly in population
  beta_a = 1,            # base treatment effect
  beta_z = 0,            # being elderly doesn't affect baseline outcome
  beta_az = 2,           # treatment works 2 units better in elderly
  noise_sd = 1
)

# Look at the sample data
head(data$sample_data)
```

### Calculating Effects

Without weights, we estimate the sample ATE. With weights, we estimate the population ATE:

```{r compare-ates}
# Sample ATE (unweighted)
sample_ate <- with(data$sample_data, 
  mean(y_sample[a_sample == 1]) - mean(y_sample[a_sample == 0]))

# Population ATE (weighted)
pop_ate <- with(data$sample_data, {
  w1 <- weights[a_sample == 1]
  w0 <- weights[a_sample == 0]
  weighted.mean(y_sample[a_sample == 1], w1) - 
  weighted.mean(y_sample[a_sample == 0], w0)
})

# True population ATE from large population data
true_pop_ate <- with(data$population_data,
  mean(y_population[a_population == 1]) - mean(y_population[a_population == 0]))

cat("Sample ATE (unweighted):", round(sample_ate, 3), "\n")
cat("Population ATE (weighted):", round(pop_ate, 3), "\n")
cat("True Population ATE:", round(true_pop_ate, 3), "\n")
cat("Expected difference:", 2 * (0.5 - 0.1), "(due to effect modification)\n")
```

### Understanding the Weights

The weights adjust for the different distribution of the effect modifier:

```{r weight-distribution}
# Examine weight values
weight_summary <- data$sample_data %>%
  group_by(z_sample) %>%
  summarise(
    n = n(),
    prop = n/nrow(data$sample_data),
    weight = first(weights)
  )

print(weight_summary)

# Visualize weight distribution
ggplot(data$sample_data, aes(x = factor(z_sample), y = weights)) +
  geom_boxplot() +
  geom_point(alpha = 0.1) +
  labs(x = "Effect Modifier Z", y = "Transport Weight",
       title = "Transport Weights by Effect Modifier Status") +
  theme_minimal()
```

## Transport with Observational Shadows

Real-world data has measurement error, missing data, and other distortions. The `margot_transport_analysis()` function shows how these "shadows" affect transported estimates.

### Example: Measurement Error

Let's see how measurement error in the treatment variable affects our transported estimates:

```{r transport-with-shadows}
# Analysis with measurement error
result <- margot_transport_analysis(
  n_sample = 2000,
  p_z_sample = 0.1,
  p_z_population = 0.5,
  beta_a = 1,
  beta_z = 0,
  beta_az = 2,  # strong effect modification
  apply_shadows = TRUE,
  shadow_config = list(
    measurement_error = TRUE,
    missingness = FALSE
  ),
  seed = 2025
)

# Compare bias in sample vs population
print(result$bias_comparison)
```

Key insights:
- Measurement error causes bias in both populations
- The bias may differ between sample and target populations
- Effect modification can amplify or dampen bias from shadows

### Example: Differential Missingness

Now let's add outcome missingness that depends on the effect modifier:

```{r differential-missingness}
# Analysis with differential missingness
result2 <- margot_transport_analysis(
  n_sample = 2000,
  p_z_sample = 0.1,
  p_z_population = 0.5,
  beta_a = 1,
  beta_z = 0,
  beta_az = 2,
  apply_shadows = TRUE,
  shadow_config = list(
    measurement_error = FALSE,
    missingness = TRUE  # MAR depending on Z
  ),
  seed = 2025
)

print(result2$bias_comparison)
```

### Combining Multiple Shadows

Real data often has multiple problems simultaneously:

```{r multiple-shadows}
# Both measurement error and missingness
result3 <- margot_transport_analysis(
  n_sample = 2000,
  p_z_sample = 0.1,
  p_z_population = 0.5,
  beta_a = 1,
  beta_z = 0,
  beta_az = 2,
  apply_shadows = TRUE,
  shadow_config = list(
    measurement_error = TRUE,
    missingness = TRUE
  ),
  seed = 2025
)

# Extract detailed results
cat("\n=== Sample Population (Unweighted) ===\n")
print(result3$comparison_sample$comparison)

cat("\n=== Target Population (Weighted) ===\n")
print(result3$comparison_population$comparison)
```

## Visualizing Shadow Effects Across Populations

Let's create a more comprehensive comparison across different scenarios:

```{r comprehensive-comparison, fig.height=6}
# Run multiple scenarios
scenarios <- expand.grid(
  measurement_error = c(FALSE, TRUE),
  missingness = c(FALSE, TRUE),
  stringsAsFactors = FALSE
)

# Add a "clean" scenario
scenarios <- rbind(
  data.frame(measurement_error = FALSE, missingness = FALSE),
  scenarios[-1,]
)

# Run analyses
results_list <- list()
for (i in 1:nrow(scenarios)) {
  config <- list(
    measurement_error = scenarios$measurement_error[i],
    missingness = scenarios$missingness[i]
  )
  
  res <- margot_transport_analysis(
    n_sample = 1500,
    p_z_sample = 0.1,
    p_z_population = 0.5,
    beta_a = 1,
    beta_az = 2,
    apply_shadows = any(unlist(config)),
    shadow_config = config,
    seed = 2025 + i
  )
  
  if (any(unlist(config))) {
    results_list[[i]] <- res$bias_comparison %>%
      mutate(
        scenario = paste(
          ifelse(config$measurement_error, "ME", ""),
          ifelse(config$missingness, "Miss", ""),
          sep = "+"
        )
      )
  } else {
    # For clean data, create a comparison with no bias
    results_list[[i]] <- data.frame(
      Population = c("Sample (unweighted)", "Target (weighted)"),
      True_ATE = c(res$effects_sample$ate, res$effects_population$ate),
      Observed_ATE = c(res$effects_sample$ate, res$effects_population$ate),
      Bias = c(0, 0),
      Relative_Bias = c(0, 0),
      scenario = "Clean"
    )
  }
}

# Combine results
all_results <- do.call(rbind, results_list)

# Clean up scenario names
all_results$scenario <- trimws(gsub("\\+$", "", all_results$scenario))
all_results$scenario[all_results$scenario == ""] <- "Clean"

# Plot bias comparison
ggplot(all_results, aes(x = scenario, y = Bias, fill = Population)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "Shadow Bias in Sample vs Target Population",
    subtitle = "Effect of measurement error (ME) and missingness (Miss) on transported estimates",
    x = "Shadow Scenario",
    y = "Bias in ATE Estimate"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Practical Implications

### 1. **Differential Bias**
Shadows can cause different amounts of bias in the sample versus target population, especially with effect modification:

```{r differential-bias-demo}
# Strong effect modification example
strong_em <- margot_transport_analysis(
  n_sample = 2000,
  p_z_sample = 0.2,
  p_z_population = 0.8,  # very different populations
  beta_a = 0.5,
  beta_az = 3,  # very strong effect modification
  apply_shadows = TRUE,
  shadow_config = list(measurement_error = TRUE, missingness = FALSE),
  seed = 42
)

# Weak effect modification example  
weak_em <- margot_transport_analysis(
  n_sample = 2000,
  p_z_sample = 0.2,
  p_z_population = 0.8,
  beta_a = 2,
  beta_az = 0.2,  # weak effect modification
  apply_shadows = TRUE,
  shadow_config = list(measurement_error = TRUE, missingness = FALSE),
  seed = 42
)

cat("Strong Effect Modification:\n")
print(strong_em$bias_comparison[, c("Population", "Bias", "Relative_Bias")])

cat("\nWeak Effect Modification:\n")
print(weak_em$bias_comparison[, c("Population", "Bias", "Relative_Bias")])
```

### 2. **Weight Diagnostics**

Always check your weights for extreme values:

```{r weight-diagnostics}
# Generate example with more extreme weight scenario
extreme_data <- simulate_ate_data_with_weights(
  n_sample = 1000,
  p_z_sample = 0.05,   # very few elderly in sample
  p_z_population = 0.7  # mostly elderly in population
)

# Weight diagnostics
weights <- extreme_data$sample_data$weights
cat("Weight Summary:\n")
cat("  Mean:", mean(weights), "\n")
cat("  SD:", sd(weights), "\n")
cat("  Min:", min(weights), "\n")
cat("  Max:", max(weights), "\n")
cat("  Effective Sample Size:", sum(weights)^2 / sum(weights^2), "\n")

# Visualize weight distribution
hist(weights, breaks = 30, main = "Distribution of Transport Weights",
     xlab = "Weight", col = "lightblue")
abline(v = 1, col = "red", lty = 2, lwd = 2)
```

### 3. **Combining with margot.sim's Shadow Framework**

You can create custom shadows for transport analyses:

```{r custom-shadow-transport}
# Start with basic transported data
base_data <- simulate_ate_data_with_weights(
  n_sample = 1000,
  p_z_sample = 0.1,
  p_z_population = 0.5,
  beta_a = 1,
  beta_az = 1.5
)

# Convert to margot format
margot_data <- data.frame(
  id = 1:1000,
  b1 = base_data$sample_data$z_sample,
  t0_a = base_data$sample_data$a_sample,
  t2_y = base_data$sample_data$y_sample,
  sampling_weight = base_data$sample_data$weights
)

# Apply custom shadow configuration
shadows <- list(
  create_shadow(
    type = "measurement_error",
    params = list(
      variables = "t0_a",
      error_type = "classical",  # simple classical error for this example
      sigma = 0.25
    ),
    name = "treatment_measurement_error"
  )
)

# Apply shadows and analyze
shadow_result <- apply_shadows_with_truth(margot_data, shadows)
effects_comparison <- compare_shadow_effects(
  shadow_result,
  wave = 0,
  outcome_wave = 2,
  weights = margot_data$sampling_weight
)

print(effects_comparison$comparison)
```

## Summary

Transport weights are essential for generalizing from samples to populations when:
1. The distribution of effect modifiers differs
2. Treatment effects are heterogeneous

However, observational shadows complicate transport:
- Measurement error and missingness can bias transported estimates
- The bias may differ between source and target populations
- Strong effect modification can amplify shadow bias

The margot.sim framework helps you:
- Generate realistic scenarios with both transport weights and shadows
- Evaluate how different data problems affect generalizability
- Design studies that are robust to these challenges

### Key Takeaways

1. **Always check for effect modification** before transporting results
2. **Evaluate weight distributions** to ensure stable estimates
3. **Consider how shadows interact with transport** - bias can be population-specific
4. **Use sensitivity analyses** to understand robustness of transported estimates