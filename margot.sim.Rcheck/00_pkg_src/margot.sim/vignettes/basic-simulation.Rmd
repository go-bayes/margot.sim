---
title: "Basic Simulation with margot.sim"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic Simulation with margot.sim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(margot.sim)
```

## Introduction

The `margot.sim` package extends the `margot` package to provide sophisticated simulation capabilities for longitudinal data analysis. This vignette demonstrates the basic workflow for simulating longitudinal data with realistic observational challenges.

## Basic Simulation

The core function `margot_simulate()` generates longitudinal data following a semi-Markovian structural causal model (SCM):

```{r basic-sim}
# Simulate basic longitudinal data
set.seed(123)
sim_data <- margot_simulate(
  n = 1000,      # Number of subjects
  waves = 3,     # Number of measurement waves
  n_outcomes = 1 # Number of outcomes (default)
)

# View structure
str(sim_data[1:5, 1:10])
```

The generated data includes:
- `id`: Subject identifier
- `b1-b5`: Baseline covariates
- `t0_a`, `t1_a`, etc.: Treatment/exposure at each wave
- `t0_y`, `t1_y`, etc.: Outcomes at each wave
- `t1_l`, `t2_l`, etc.: Time-varying confounders

## Customizing the Data Generation Process

You can customize various aspects of the simulation:

```{r custom-sim}
# Custom simulation with specific parameters
sim_custom <- margot_simulate(
  n = 500,
  waves = 4,
  n_baselines = 3,        # Fewer baseline covariates
  exposure_type = "continuous",  # Continuous exposure
  outcome_type = "binary",       # Binary outcome
  params = list(
    b_a_coef = 0.3,      # Baseline → exposure effect
    a_y_coef = 0.5,      # Exposure → outcome effect
    b_y_coef = 0.2       # Baseline → outcome effect
  )
)

# Check exposure and outcome types
summary(sim_custom$t1_a)  # Continuous
table(sim_custom$t2_y)    # Binary
```

## Adding Censoring

Real-world longitudinal studies often have dropout. You can add censoring:

```{r censoring}
# Simulate with censoring
sim_censored <- margot_simulate(
  n = 1000,
  waves = 3,
  censoring = list(
    rate = 0.2,                    # 20% censoring rate per wave
    exposure_dependence = TRUE,    # Censoring depends on exposure
    y_dependence = TRUE           # Censoring depends on outcome
  )
)

# Check censoring indicators
table(sim_censored$t0_not_lost_following_wave)
table(sim_censored$t1_not_lost_following_wave)
```

## Working with Long Format

For many analyses, you may want data in long format:

```{r long-format}
# Generate in long format
sim_long <- margot_simulate(
  n = 200,
  waves = 3,
  wide = FALSE  # Request long format
)

# View structure
head(sim_long)

# Number of observations per person
table(table(sim_long$id))
```

## Using Interventions

You can simulate data under specific intervention regimes:

```{r interventions}
# Define an intervention that sets treatment to 1 for everyone
always_treat <- function(data, time, trt) {
  rep(1, nrow(data))
}

# Simulate under intervention
sim_intervention <- margot_simulate(
  n = 500,
  waves = 2,
  intervention = always_treat
)

# Verify intervention was applied
table(sim_intervention$t1_a)  # All 1s
```

## Next Steps

This vignette covered basic simulation. See other vignettes for:

- **Applying Shadows**: How to add measurement error, missingness, and selection bias
- **Monte Carlo Evaluation**: How to evaluate estimator performance
- **Causal Inference**: How to simulate data for causal effect estimation

## Summary

The `margot_simulate()` function provides a flexible framework for generating realistic longitudinal data with:

- Customizable structural causal models
- Various exposure and outcome types  
- Realistic censoring patterns
- Support for interventions
- Both wide and long format output

This forms the foundation for more advanced simulation studies to evaluate statistical methods under realistic conditions.